<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>CanlÄ± Duygu Analizi</title>
    <style>
        :root{
            --bg: #0b1020;
            --panel: #0f172a;
            --card: #111827;
            --text: #e5e7eb;
            --muted: #94a3b8;
            --accent: #00e5ff;
            --accent-2: #8b5cf6;
        }
        *{ box-sizing: border-box; }
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
            text-align: center;
            color: var(--text);
            background:
                radial-gradient(1200px 600px at 10% -20%, #0b3a4a 0%, transparent 60%),
                radial-gradient(800px 400px at 110% 10%, #2a104a 0%, transparent 60%),
                linear-gradient(180deg, var(--bg), #060914 60%);
            min-height: 100vh;
            margin: 0;
            padding-bottom: 32px;
        }
        h1 {
            margin: 20px 0 8px;
            background: linear-gradient(90deg, var(--accent), #66e0ff, var(--accent-2));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: 0.5px;
            text-shadow: 0 0 20px rgba(0,229,255,0.25);
        }
        .live {
            margin-top: 15px;
            border-radius: 16px;
            border: 0;
            box-shadow: 0 0 0 1px rgba(0,229,255,0.18), 0 18px 40px -20px rgba(0,229,255,0.45);
        }
        #panel {
            margin: 24px auto;
            max-width: 1400px;
            text-align: left;
            padding: 0 16px;
        }
        #liveArea {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        #liveArea img {
            flex: 0 0 auto;
            max-width: 640px;
        }
        #realtimeContainer {
            flex: 0 0 320px;
            min-width: 280px;
        }
        .toolbar {
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
        }
        .btn{
            padding: 10px 18px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.08);
            background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.04));
            color: var(--text);
            cursor: pointer;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06), 0 8px 20px -12px rgba(0,0,0,0.5);
            transition: transform .15s ease, box-shadow .2s ease, background .2s ease;
        }
        .btn:hover{ transform: translateY(-1px); box-shadow: 0 12px 28px -16px rgba(0,0,0,0.7); }
        .btn:active{ transform: translateY(0); }
        .btn-primary{ border-color: rgba(0,229,255,0.25); background: linear-gradient(180deg, rgba(0,229,255,0.12), rgba(0,229,255,0.08)); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06), 0 8px 20px -12px rgba(0,229,255,0.5); }
        .btn-green{ border-color: rgba(34,197,94,0.25); background: linear-gradient(180deg, rgba(34,197,94,0.18), rgba(34,197,94,0.10)); }
        .btn-red{ border-color: rgba(239,68,68,0.25); background: linear-gradient(180deg, rgba(239,68,68,0.18), rgba(239,68,68,0.10)); }
        #count{ color: var(--muted); }

        #cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 18px;
            margin-top: 18px;
        }
        .card {
            background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent), var(--card);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 14px;
            box-shadow: 0 10px 30px -18px rgba(0,0,0,0.6);
            overflow: hidden;
            transform: translateY(8px);
            animation: fadeInUp .6s ease both;
            transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
        }
        .card:hover{
            transform: translateY(0) scale(1.01);
            box-shadow: 0 20px 48px -18px rgba(0,229,255,0.25);
            border-color: rgba(0,229,255,0.18);
        }
        .card img { width: 100%; height: 180px; object-fit: cover; border: 0; border-radius: 0; filter: saturate(1.05) contrast(1.02); }
        .card .body { padding: 12px 14px 14px; }
        .meta { font-size: 12px; color: var(--muted); margin-bottom: 8px; }
        .title { font-weight: 600; color: #f3f4f6; }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            background: rgba(0,229,255,0.14);
            color: #b3f7ff;
            border: 1px solid rgba(0,229,255,0.25);
            border-radius: 999px;
            font-size: 12px;
            margin-left: 6px;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04);
        }
        .emotions { margin-top: 10px; }
        .emo-row { display:flex; align-items:center; gap:10px; font-size:12px; color:#cbd5e1; }
        .emo-row .label{ width: 88px; flex: 0 0 88px; color:#a3b2c7; }
        .bar { flex:1; background: rgba(255,255,255,0.06); height:8px; border-radius:999px; overflow:hidden; box-shadow: inset 0 1px 2px rgba(0,0,0,0.35); }
        .bar > span { display:block; height:100%; width:0%; background: linear-gradient(90deg, var(--accent), #66e0ff); border-radius:999px; transition: width .8s cubic-bezier(.22,.9,.31,1); box-shadow: 0 0 12px rgba(0,229,255,0.35); }
        .grid { display:grid; grid-template-columns: 1fr; gap:8px; }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(8px); }
        }
    </style>
</head>
<body>
    <h1>ğŸ¥ CanlÄ± Duygu Analizi</h1>
    
    <div id="panel">
        <div class="toolbar">
            <input id="ipInput" type="text" placeholder="Kamera IP (Ã¶rn. 10.64.220.189)" value="10.64.220.189" style="padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:var(--text);width:200px">
            <button id="btnConnect" class="btn btn-primary">BaÄŸlan</button>
            <button id="btnDisconnect" class="btn">Yerel Kamera</button>
            <button id="btnStart" class="btn btn-green">AlgÄ±lamayÄ± AÃ§</button>
            <button id="btnStop" class="btn btn-red">AlgÄ±lamayÄ± Kapat</button>
            <button id="refresh" class="btn btn-primary">Paneli Yenile</button>
            <span id="status" class="meta"></span>
            <span id="count" class="meta"></span>
        </div>
        
        <!-- ESP Camera Controls - Only shown when connected -->
        <div id="espControls" style="display:none; margin-top:16px; padding:16px; background:var(--card); border-radius:12px; border:1px solid rgba(0,229,255,0.2);">
            <h3 style="margin:0 0 12px 0; font-size:16px; color:var(--accent);">âš™ï¸ ESP32 Kamera AyarlarÄ±</h3>
            
            <!-- Preset Buttons -->
            <div style="margin-bottom:16px; padding:12px; background:rgba(0,229,255,0.05); border-radius:8px;">
                <div style="margin-bottom:8px; color:var(--muted); font-size:13px;">ğŸ¯ Ã–nceden TanÄ±mlÄ± Ayarlar:</div>
                <button class="btn btn-primary" onclick="applyOptimalPreset()">âœ¨ Duygu Analizi Ä°Ã§in Optimize Et</button>
                <button class="btn" onclick="refreshESPStatus()">ğŸ”„ Mevcut AyarlarÄ± GÃ¶ster</button>
            </div>
            
            <!-- Manual Controls -->
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px;">
                <!-- Resolution -->
                <div style="padding:12px; background:rgba(255,255,255,0.02); border-radius:8px; border:1px solid rgba(255,255,255,0.06);">
                    <div style="color:var(--muted); font-size:12px; margin-bottom:8px;">ğŸ“ Ã‡Ã¶zÃ¼nÃ¼rlÃ¼k</div>
                    <select id="framesize" onchange="setESPParam('framesize', this.value)" style="width:100%; padding:8px; border-radius:6px; background:var(--panel); color:var(--text); border:1px solid rgba(255,255,255,0.1);">
                        <option value="10">UXGA (1600x1200)</option>
                        <option value="9">SXGA (1280x1024)</option>
                        <option value="8" selected>XGA (1024x768) â­</option>
                        <option value="7">SVGA (800x600)</option>
                        <option value="6">VGA (640x480)</option>
                        <option value="5">CIF (352x288)</option>
                        <option value="4">QVGA (320x240)</option>
                    </select>
                </div>
                
                <!-- Quality -->
                <div style="padding:12px; background:rgba(255,255,255,0.02); border-radius:8px; border:1px solid rgba(255,255,255,0.06);">
                    <div style="color:var(--muted); font-size:12px; margin-bottom:8px;">ğŸ¨ JPEG Kalitesi</div>
                    <input type="range" id="quality" min="10" max="63" value="10" oninput="setESPParam('quality', this.value); document.getElementById('qualityVal').textContent=this.value" style="width:100%;">
                    <div style="font-size:11px; color:var(--muted); margin-top:4px;">DeÄŸer: <span id="qualityVal">10</span> (10=En Ä°yi)</div>
                </div>
                
                <!-- Brightness -->
                <div style="padding:12px; background:rgba(255,255,255,0.02); border-radius:8px; border:1px solid rgba(255,255,255,0.06);">
                    <div style="color:var(--muted); font-size:12px; margin-bottom:8px;">â˜€ï¸ ParlaklÄ±k</div>
                    <input type="range" id="brightness" min="-2" max="2" value="0" oninput="setESPParam('brightness', this.value); document.getElementById('brightnessVal').textContent=this.value" style="width:100%;">
                    <div style="font-size:11px; color:var(--muted); margin-top:4px;">DeÄŸer: <span id="brightnessVal">0</span></div>
                </div>
                
                <!-- Contrast -->
                <div style="padding:12px; background:rgba(255,255,255,0.02); border-radius:8px; border:1px solid rgba(255,255,255,0.06);">
                    <div style="color:var(--muted); font-size:12px; margin-bottom:8px;">ğŸ”² Kontrast</div>
                    <input type="range" id="contrast" min="-2" max="2" value="0" oninput="setESPParam('contrast', this.value); document.getElementById('contrastVal').textContent=this.value" style="width:100%;">
                    <div style="font-size:11px; color:var(--muted); margin-top:4px;">DeÄŸer: <span id="contrastVal">0</span></div>
                </div>
                
                <!-- Saturation -->
                <div style="padding:12px; background:rgba(255,255,255,0.02); border-radius:8px; border:1px solid rgba(255,255,255,0.06);">
                    <div style="color:var(--muted); font-size:12px; margin-bottom:8px;">ğŸŒˆ Doygunluk</div>
                    <input type="range" id="saturation" min="-2" max="2" value="0" oninput="setESPParam('saturation', this.value); document.getElementById('saturationVal').textContent=this.value" style="width:100%;">
                    <div style="font-size:11px; color:var(--muted); margin-top:4px;">DeÄŸer: <span id="saturationVal">0</span></div>
                </div>
                
                <!-- Special Effect -->
                <div style="padding:12px; background:rgba(255,255,255,0.02); border-radius:8px; border:1px solid rgba(255,255,255,0.06);">
                    <div style="color:var(--muted); font-size:12px; margin-bottom:8px;">âœ¨ Ã–zel Efekt</div>
                    <select id="special_effect" onchange="setESPParam('special_effect', this.value)" style="width:100%; padding:8px; border-radius:6px; background:var(--panel); color:var(--text); border:1px solid rgba(255,255,255,0.1);">
                        <option value="0">Yok</option>
                        <option value="1">Negatif</option>
                        <option value="2">Gri Tonlama</option>
                        <option value="3">KÄ±rmÄ±zÄ± Ton</option>
                        <option value="4">YeÅŸil Ton</option>
                        <option value="5">Mavi Ton</option>
                        <option value="6">Sepia</option>
                    </select>
                </div>
            </div>
            
            <!-- Auto Settings -->
            <div style="margin-top:12px; padding:12px; background:rgba(255,255,255,0.02); border-radius:8px; border:1px solid rgba(255,255,255,0.06);">
                <div style="color:var(--muted); font-size:12px; margin-bottom:8px;">ğŸ¤– Otomatik Ayarlar</div>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                        <input type="checkbox" id="awb" onchange="setESPParam('awb', this.checked?1:0)" checked>
                        <span style="font-size:13px;">Auto White Balance</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                        <input type="checkbox" id="aec" onchange="setESPParam('aec', this.checked?1:0)" checked>
                        <span style="font-size:13px;">Auto Exposure</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                        <input type="checkbox" id="agc" onchange="setESPParam('agc', this.checked?1:0)" checked>
                        <span style="font-size:13px;">Auto Gain</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                        <input type="checkbox" id="awb_gain" onchange="setESPParam('awb_gain', this.checked?1:0)" checked>
                        <span style="font-size:13px;">AWB Gain</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                        <input type="checkbox" id="lenc" onchange="setESPParam('lenc', this.checked?1:0)" checked>
                        <span style="font-size:13px;">Lens DÃ¼zeltme</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                        <input type="checkbox" id="hmirror" onchange="setESPParam('hmirror', this.checked?1:0)">
                        <span style="font-size:13px;">Yatay Ayna</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                        <input type="checkbox" id="vflip" onchange="setESPParam('vflip', this.checked?1:0)">
                        <span style="font-size:13px;">Dikey Ã‡evir</span>
                    </label>
                </div>
            </div>
            
            <!-- Status Display -->
            <div id="espStatusDisplay" style="margin-top:12px; padding:12px; background:rgba(139,92,246,0.1); border-radius:8px; border:1px solid rgba(139,92,246,0.2); display:none;">
                <div style="color:var(--accent-2); font-size:13px; font-weight:600; margin-bottom:8px;">ğŸ“Š Mevcut Ayarlar</div>
                <div id="espStatusContent" style="font-size:12px; color:var(--muted); line-height:1.6;"></div>
            </div>
        </div>
        
        <div id="liveArea">
            <img id="liveImg" class="live" src="{{ url_for('video_feed') }}" width="640" height="480" alt="CanlÄ± YayÄ±n">
            <div id="realtimeContainer">
                <div id="realtime" class="card">
                    <div class="body">
                        <div class="title">AnlÄ±k Duygular <span id="rt-main" class="badge">-</span></div>
                        <div class="meta" id="rt-meta">Durum: -</div>
                        <div id="rt-bars" class="emotions grid"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="cards"></div>
    </div>

    <script>
        const trEmo = { happy: 'Mutlu', sad: 'ÃœzgÃ¼n', angry: 'KÄ±zgÄ±n', surprise: 'ÅaÅŸÄ±rmÄ±ÅŸ', fear: 'KorkmuÅŸ', disgust: 'TiksinmiÅŸ', neutral: 'NÃ¶tr' };
        const emoColors = {
            angry: '#ef4444',
            fear: '#a855f7',
            disgust: '#22c55e',
            sad: '#3b82f6',
            surprise: '#f59e0b',
            happy: '#facc15',
            neutral: '#9ca3af'
        };
        function pct(n){ return typeof n === 'number' ? n.toFixed(1) : '0.0'; }
        let rtTimer = null;

        async function fetchJsonIfExists(url){
            try{
                const res = await fetch(url);
                if(!res.ok) return null;
                return await res.json();
            }catch(e){ return null; }
        }

        async function loadPanel(){
            const res = await fetch('/captured');
            const images = await res.json();
            const cards = document.getElementById('cards');
            const count = document.getElementById('count');
            cards.innerHTML = '';
            count.textContent = `${images.length} kayÄ±t`;

            // Yeni -> Eski sÄ±ralama (dosya adÄ±nda timestamp var)
            images.sort((a,b)=> a < b ? 1 : -1);

            for (let i=0;i<images.length;i++){
                const imgName = images[i];
                const base = imgName.replace(/\.jpg$/i, '');
                const jsonUrl = `/static/captured/${base}.json`;
                const data = await fetchJsonIfExists(jsonUrl);

                const card = document.createElement('div');
                card.className = 'card';
                card.style.animationDelay = `${i * 0.05}s`;

                const img = document.createElement('img');
                img.src = `/static/captured/${imgName}`;
                img.alt = base;
                card.appendChild(img);

                const body = document.createElement('div');
                body.className = 'body';

                const title = document.createElement('div');
                title.className = 'title';

                let main = 'Bilinmiyor';
                let dangerScore = 0;
                let emotions = null;
                let timestamp = '';
                let pid = '';
                if (data && data.emotions){
                    emotions = data.emotions;
                    timestamp = data.timestamp || '';
                    pid = data.id || '';
                    main = Object.keys(emotions).reduce((a,b)=> emotions[a] > emotions[b] ? a : b);
                    dangerScore = (emotions.angry||0) + (emotions.fear||0) + (emotions.disgust||0);
                } else {
                    // JSON yoksa, dosya adÄ±ndaki parÃ§alardan id ve zamanÄ± tahmin et (id_timestamp)
                    const parts = base.split('_');
                    pid = parts[0] || '';
                    timestamp = parts[1] || '';
                }

                const badgeColor = emoColors[main] || '#00e5ff';
                const badge = `<span class="badge" style="border-color:${badgeColor}; color:${badgeColor}; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04), 0 0 14px ${badgeColor}33;">${trEmo[main] || main}</span>`;
                title.innerHTML = `KiÅŸi ID: ${pid || '-'} ${badge}`;

                const meta = document.createElement('div');
                meta.className = 'meta';
                meta.textContent = `Zaman: ${timestamp} ${emotions ? `â€¢ Tehlike Skoru: ${pct(dangerScore)}%` : ''}`;

                const emotionsEl = document.createElement('div');
                emotionsEl.className = 'emotions grid';

                if (emotions){
                    const order = ['angry','fear','disgust','sad','surprise','happy','neutral'];
                    order.forEach(k => {
                        if (typeof emotions[k] === 'undefined') return;
                        const row = document.createElement('div');
                        row.className = 'emo-row';
                        const label = document.createElement('span');
                        label.className = 'label';
                        label.textContent = trEmo[k] || k;
                        const bar = document.createElement('div');
                        bar.className = 'bar';
                        const fill = document.createElement('span');
                        const color = emoColors[k] || '#66e0ff';
                        fill.style.background = color;
                        fill.style.boxShadow = `0 0 12px ${color}66`;
                        // BaÅŸta 0, sonra hedefe animasyon
                        fill.style.width = '0%';
                        const target = Math.min(100, Math.max(0, emotions[k]));
                        requestAnimationFrame(()=>{ requestAnimationFrame(()=>{ fill.style.width = target + '%'; }); });
                        bar.appendChild(fill);
                        const value = document.createElement('span');
                        value.textContent = pct(emotions[k]) + '%';
                        row.appendChild(label);
                        row.appendChild(bar);
                        row.appendChild(value);
                        emotionsEl.appendChild(row);
                    });
                }

                body.appendChild(title);
                body.appendChild(meta);
                body.appendChild(emotionsEl);
                card.appendChild(body);
                cards.appendChild(card);
            }
        }

        async function setDetection(enabled){
            await fetch('/set_detection', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({enabled}) });
            await updateStatus();
        }

        function startRealtime(){
            if (rtTimer === null){
                rtTimer = setInterval(loadRealtime, 1000);
                // Hemen bir kez Ã§ek
                loadRealtime();
            }
        }
        function stopRealtime(){
            if (rtTimer !== null){
                clearInterval(rtTimer);
                rtTimer = null;
            }
        }
        async function updateStatus(){
            const res = await fetch('/status');
            const data = await res.json();
            const st = document.getElementById('status');
            st.textContent = `AlgÄ±lama: ${data.enabled ? 'AÃ§Ä±k' : 'KapalÄ±'}`;
            if (data.enabled){
                startRealtime();
            } else {
                stopRealtime();
            }
        }

        async function loadRealtime(){
            const res = await fetch('/current_emotions');
            const data = await res.json();
            const rtMain = document.getElementById('rt-main');
            const rtMeta = document.getElementById('rt-meta');
            const rtBars = document.getElementById('rt-bars');
            rtBars.innerHTML = '';

            const enabled = data.enabled;
            const ts = data.timestamp || '';
            const em = data.emotions || null;
            const main = data.main_emotion || '-';
            const dsc = data.danger_score || 0;

            // YÃ¼z algÄ±lanmadÄ±ysa duygu bilgisi gÃ¶sterme
            const faceDetected = em && Object.keys(em).length > 0 && Object.values(em).some(v => v > 0);
            
            if (!faceDetected) {
                rtMain.textContent = '-';
                rtMeta.textContent = `Durum: ${enabled ? 'AÃ§Ä±k' : 'KapalÄ±'} â€¢ YÃ¼z algÄ±lanmadÄ±`;
                return;
            }

            rtMain.textContent = trEmo[main] || main;
            rtMeta.textContent = `Durum: ${enabled ? 'AÃ§Ä±k' : 'KapalÄ±'} â€¢ Zaman: ${ts} â€¢ Tehlike Skoru: ${pct(dsc)}%`;

            if (em){
                const order = ['angry','fear','disgust','sad','surprise','happy','neutral'];
                order.forEach(k => {
                    if (typeof em[k] === 'undefined') return;
                    const row = document.createElement('div');
                    row.className = 'emo-row';
                    const label = document.createElement('span');
                    label.className = 'label';
                    label.textContent = trEmo[k] || k;
                    const bar = document.createElement('div');
                    bar.className = 'bar';
                    const fill = document.createElement('span');
                    const color = emoColors[k] || '#66e0ff';
                    fill.style.background = color;
                    fill.style.boxShadow = `0 0 12px ${color}66`;
                    fill.style.width = '0%';
                    const target = Math.min(100, Math.max(0, em[k]));
                    requestAnimationFrame(()=>{ requestAnimationFrame(()=>{ fill.style.width = target + '%'; }); });
                    bar.appendChild(fill);
                    const value = document.createElement('span');
                    value.textContent = pct(em[k]) + '%';
                    row.appendChild(label);
                    row.appendChild(bar);
                    row.appendChild(value);
                    rtBars.appendChild(row);
                });
            }
        }

        document.getElementById('refresh').onclick = loadPanel;
        document.getElementById('btnStart').onclick = () => setDetection(true);
        document.getElementById('btnStop').onclick = () => setDetection(false);
        
        let currentESPip = null;
        
        // Connect / Disconnect to remote ESP32 camera by IP
        function connectStream(){
            const ip = document.getElementById('ipInput').value.trim();
            if (!ip) return alert('LÃ¼tfen bir IP girin');
            const img = document.getElementById('liveImg');
            img.src = `/video_feed?ip=${encodeURIComponent(ip)}`;
            document.getElementById('status').textContent = `BaÄŸlanÄ±yor: ${ip}`;
            
            // Show ESP controls
            currentESPip = ip;
            document.getElementById('espControls').style.display = 'block';
            
            // Load current settings
            setTimeout(() => refreshESPStatus(), 1000);
        }
        
        function disconnectStream(){
            // revert to local/default camera (server-side)
            const img = document.getElementById('liveImg');
            img.src = `{{ url_for('video_feed') }}`;
            document.getElementById('status').textContent = `Yerel kameraya geÃ§ildi`;
            
            // Hide ESP controls
            currentESPip = null;
            document.getElementById('espControls').style.display = 'none';
        }
        
        document.getElementById('btnConnect').onclick = connectStream;
        document.getElementById('btnDisconnect').onclick = disconnectStream;
        
        // ESP Camera Parameter Control
        async function setESPParam(param, value) {
            if (!currentESPip) {
                alert('LÃ¼tfen Ã¶nce ESP kamerasÄ±na baÄŸlanÄ±n');
                return;
            }
            
            try {
                const res = await fetch('/esp_command', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        ip: currentESPip, 
                        params: { var: param, val: value } 
                    })
                });
                
                const result = await res.json();
                if (result.status === 200) {
                    console.log('âœ“ ESP ayar uygulandÄ±:', param, '=', value);
                } else {
                    console.warn('âš  ESP ayar hatasÄ±:', result);
                    alert(`Ayar hatasÄ±: ${param}`);
                }
            } catch (e) {
                console.error('âŒ ESP komut gÃ¶nderme hatasÄ±:', e);
                alert('ESP ile iletiÅŸim hatasÄ±');
            }
        }
        
        // Apply Optimal Preset for Emotion Analysis
        async function applyOptimalPreset() {
            if (!currentESPip) {
                alert('LÃ¼tfen Ã¶nce ESP kamerasÄ±na baÄŸlanÄ±n');
                return;
            }
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'â³ Ayarlar uygulanÄ±yor...';
            
            try {
                const res = await fetch('/esp_apply_preset', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ ip: currentESPip })
                });
                
                const result = await res.json();
                if (result.status === 'success') {
                    alert('âœ… Optimal ayarlar baÅŸarÄ±yla uygulandÄ±!\n\n' +
                          'â€¢ Ã‡Ã¶zÃ¼nÃ¼rlÃ¼k: XGA (1024x768)\n' +
                          'â€¢ JPEG Kalitesi: En YÃ¼ksek\n' +
                          'â€¢ Otomatik Ayarlar: Aktif\n' +
                          'â€¢ YÃ¼z AlgÄ±lama: Aktif');
                    
                    // Update UI controls to reflect new settings
                    setTimeout(() => refreshESPStatus(), 500);
                } else {
                    alert('âš  BazÄ± ayarlar uygulanamadÄ±. LÃ¼tfen manuel kontrol edin.');
                }
            } catch (e) {
                console.error('âŒ Preset uygulama hatasÄ±:', e);
                alert('Ayarlar uygulanÄ±rken hata oluÅŸtu');
            } finally {
                btn.disabled = false;
                btn.textContent = 'âœ¨ Duygu Analizi Ä°Ã§in Optimize Et';
            }
        }
        
        // Refresh and display current ESP status
        async function refreshESPStatus() {
            if (!currentESPip) return;
            
            try {
                const res = await fetch(`/esp_status?ip=${encodeURIComponent(currentESPip)}`);
                const result = await res.json();
                
                if (result.status === 'success' && result.settings) {
                    const settings = result.settings;
                    
                    // Update UI controls
                    if (settings.framesize !== undefined) {
                        document.getElementById('framesize').value = settings.framesize;
                    }
                    if (settings.quality !== undefined) {
                        document.getElementById('quality').value = settings.quality;
                        document.getElementById('qualityVal').textContent = settings.quality;
                    }
                    if (settings.brightness !== undefined) {
                        document.getElementById('brightness').value = settings.brightness;
                        document.getElementById('brightnessVal').textContent = settings.brightness;
                    }
                    if (settings.contrast !== undefined) {
                        document.getElementById('contrast').value = settings.contrast;
                        document.getElementById('contrastVal').textContent = settings.contrast;
                    }
                    if (settings.saturation !== undefined) {
                        document.getElementById('saturation').value = settings.saturation;
                        document.getElementById('saturationVal').textContent = settings.saturation;
                    }
                    if (settings.special_effect !== undefined) {
                        document.getElementById('special_effect').value = settings.special_effect;
                    }
                    
                    // Update checkboxes
                    if (settings.awb !== undefined) document.getElementById('awb').checked = settings.awb === 1;
                    if (settings.aec !== undefined) document.getElementById('aec').checked = settings.aec === 1;
                    if (settings.agc !== undefined) document.getElementById('agc').checked = settings.agc === 1;
                    if (settings.awb_gain !== undefined) document.getElementById('awb_gain').checked = settings.awb_gain === 1;
                    if (settings.lenc !== undefined) document.getElementById('lenc').checked = settings.lenc === 1;
                    if (settings.hmirror !== undefined) document.getElementById('hmirror').checked = settings.hmirror === 1;
                    if (settings.vflip !== undefined) document.getElementById('vflip').checked = settings.vflip === 1;
                    
                    // Display status info
                    const resolutionNames = {
                        10: 'UXGA (1600x1200)',
                        9: 'SXGA (1280x1024)',
                        8: 'XGA (1024x768)',
                        7: 'SVGA (800x600)',
                        6: 'VGA (640x480)',
                        5: 'CIF (352x288)',
                        4: 'QVGA (320x240)'
                    };
                    
                    const statusHtml = `
                        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:8px;">
                            <div>Ã‡Ã¶zÃ¼nÃ¼rlÃ¼k: <strong>${resolutionNames[settings.framesize] || settings.framesize}</strong></div>
                            <div>JPEG Kalite: <strong>${settings.quality}</strong></div>
                            <div>ParlaklÄ±k: <strong>${settings.brightness}</strong></div>
                            <div>Kontrast: <strong>${settings.contrast}</strong></div>
                            <div>Doygunluk: <strong>${settings.saturation}</strong></div>
                            <div>AWB: <strong>${settings.awb ? 'AÃ§Ä±k' : 'KapalÄ±'}</strong></div>
                            <div>AEC: <strong>${settings.aec ? 'AÃ§Ä±k' : 'KapalÄ±'}</strong></div>
                            <div>AGC: <strong>${settings.agc ? 'AÃ§Ä±k' : 'KapalÄ±'}</strong></div>
                        </div>
                    `;
                    
                    document.getElementById('espStatusContent').innerHTML = statusHtml;
                    document.getElementById('espStatusDisplay').style.display = 'block';
                    
                    console.log('âœ“ ESP ayarlarÄ± yÃ¼klendi:', settings);
                } else {
                    console.warn('âš  ESP durum bilgisi alÄ±namadÄ±');
                }
            } catch (e) {
                console.error('âŒ ESP durum sorgulama hatasÄ±:', e);
            }
        }
        
        // Ä°lk yÃ¼kleme
        updateStatus();
        loadPanel();
    </script>
</body>
</html>
